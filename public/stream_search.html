<head>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="main-container">
    <div class="center-column">
      <input id="search"></input>
      <button id="searchButton">search</button>
      <table id="streamTable" class="">
        <div class="table-header">
          <p>Total results: <p id="total-results">0</p>
          </p>
          <div class="table-header-page-arrows">
            <div id="previous-page-button" class="previous-page-button">
              <&nbsp</div> <div id="next-page-button" class="next-page-button">
                &nbsp>
            </div>
          </div>
        </div>
      </table>
      <script>
        const NUMBER_OF_STREAMS_PER_PAGE = 10;
        const twitchClientId = 'lqq3sny2wehwymql2bri1j6cbq89pi';
        let offset = 0;

        const constructUrl = (query, offset) => {
          if (!query || query == "") query = '""';
          return `https://api.twitch.tv/kraken/search/streams?query=${query}&offset=${offset}`
        }
        const getTwitchStreams = async (query, offset) => {
         debugger;
          const streamParams = await fetch(
              constructUrl(query, offset), {
                headers: {
                  "Client-ID": twitchClientId
                }
              })
            .then(function(response) {
              return response.json();
            });
          let totalStreams = streamParams._total;
          const previousButton = document.getElementById(
            "previous-page-button");
          previousButton.addEventListener("click", (function(e) {
            let baseOffset = offset - NUMBER_OF_STREAMS_PER_PAGE;
            if (baseOffset < 0) baseOffset = 0;
            getTwitchStreams(searchInput.innerHTML, baseOffset)
          }));
          const nextButton = document.getElementById("next-page-button");
          nextButton.addEventListener("click", (function(e) {
                            debugger;
            let baseOffset = offset + NUMBER_OF_STREAMS_PER_PAGE;
            if (baseOffset > totalStreams) baseOffset = totalStreams -
              NUMBER_OF_STREAMS_PER_PAGE;
            getTwitchStreams(searchInput.innerHTML, baseOffset)
          }));
          if (typeof totalStreams === "number") {
            document.getElementById("total-results")
              .innerHTML = totalStreams;
          } else {
            document.getElementById("total-results")
              .innerHTML = 0;
          }
          table.innerHTML = "";
          renderStream(table, streamParams);
        }
        const searchInput = document.getElementById("search");
        //TODO(theo): add listener on keypress
        searchInput.addEventListener("change", (function(e) {
          getTwitchStreams(e.target.value, 0)
        }));
        const table = document.getElementById("streamTable");

        const renderStream = (table, streamParams) => {
          if (!streamParams.streams || streamParams.streams.length == 0)
            return;
          streamParams.streams.forEach((stream, i) => {
            const row = table.insertRow(i);
            const displayName = streamParams.streams[i].channel
              .display_name;
            const child = document.createElement("div");
            row.className = "row-container";
            row.appendChild(child);
            child.innerHTML = child.innerHTML + `<h2>${displayName}</h2>`;
            let thumbnailUrl = streamParams.streams[i].preview.small;
            thumbnailUrl = thumbnailUrl.replace(/{width}/, '400');
            thumbnailUrl = thumbnailUrl.replace(/{height}/, '225');
            child.innerHTML = child.innerHTML +
              `<img src=${thumbnailUrl} />`;
            const streamDescription = streamParams.streams[i].channel
              .status;
            child.innerHTML = child.innerHTML +
              `<h3>${streamDescription}</h3>`;
          });
        }

        getTwitchStreams(null, 0);

      </script>
    </div>
  </div>
</body>
